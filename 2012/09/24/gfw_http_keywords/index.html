<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>HTTP URL/深度关键词检测 | Mauerspecht</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HTTP URL/深度关键词检测</h1><a id="logo" href="/.">Mauerspecht</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">HTTP URL/深度关键词检测</h1><div class="post-meta">Sep 24, 2012<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script></div><div class="post-content"><p><a href="https://gfwrev.blogspot.com/2010/03/http-url.html" target="_blank" rel="external">原文链接</a></p>
<p>一项持续时间比张某还长的遗留研究。下面是它的开发研究简介，细节很多，非研究者可以略去不看。</p>
<h3 id="HTTP-URL-深度关键词检测"><a href="#HTTP-URL-深度关键词检测" class="headerlink" title="HTTP URL/深度关键词检测"></a>HTTP URL/深度关键词检测</h3><h4 id="GFW的TCP协议阻断方式"><a href="#GFW的TCP协议阻断方式" class="headerlink" title="GFW的TCP协议阻断方式"></a>GFW的TCP协议阻断方式</h4><p>GFW只根据单向的报文还原通信内容进行协议分析和关键词判断。并且在还原通信内容时，并不检查ack域的正确性，这也符合其“better is worse的设计哲学”，对于seq重叠的包，GFW的策略是忽略后来的包，因此利用GFW的这种流重组特性对其进行欺骗也十分容易。</p>
<p>一旦GFW根据还原出的内容检测到关键词，会根据触发关键词的包和关键词类型发送type1的RST或者type2的RST/ACK，在《<a href="http://www.chinagfw.org/2009/09/gfw_21.html" target="_blank" rel="external">入侵防御系统的评测和问题</a>》中已经介绍，type2类型首次阻断中会先发送一组三个RST/ACK，序列号依次加1460、2920。type1与type2有所不同的是，type1首次阻断发送的RST的seq是关键词结束位置所在的包的ack，type2的seq则可能取为在此之前若干个包的ack，这可能与GFW处理报文的buffer大小和更新方式有关。在有些地区，单向发送内容触发type2关键词之后本地无法收到RST/ACK（对方可以收到），除非对方回复过任何设置了ACK选项的tcp包，另一些地区则本地总可以收到RST/ACK，原因还不清楚。这些问题希望有兴趣的读者自行研究。</p>
<p>特定情况下GFW还会伪造通信，例如type2的继发阻断中发送伪造的SYN/ACK企图劫持连接（为什么功能没有开发完全？），再如GFW的邮件检测模块对smtp协议的阻断会先伪造对方发送一条错误信息，再进行阻断。</p>
<h4 id="URL关键词的检测"><a href="#URL关键词的检测" class="headerlink" title="URL关键词的检测"></a>URL关键词的检测</h4><p>GFW的HTTP关键词检测模块的具体细节不是这里的重点，这里只回顾一些有关关键词检测的内容：</p>
<ul>
<li>GFW有两种不相关的type、GFW结点的划分与TCP包的源端口无关、GFW时常有结点不工作、type1不工作的节点和type2不工作的结点不同。</li>
<li>URL关键词同样也有type1、type2之分。</li>
<li>即使单向发送HTTP询问在一些地区可能无法收到GFW的type2 RST/ACK，实际上确实触发了关键词，会有90秒继发封锁。</li>
<li>如果询问的格式是GET <a href="http://url" target="_blank" rel="external">http://url</a> HTTP/1.1\r\n\r\n，GFW进行关键词测试串的就是url。</li>
<li>如果询问的格式是GET /url HTTP/1.1\r\nHost: hostname\r\n\r\n，GFW进行关键词测试的串就是.hostname/url。</li>
<li>GFW的HTTP URL关键词有普通的字符串关键词还有string1 &amp;&amp; string2 &amp;&amp; string3型的关键词，例如.google.com &amp;&amp; great &amp;&amp; firewall。只要url中包含这三个子串，无论出现的顺序如何，都会触发GFW。<del>令人疑惑的是，string1*string2这种关键词匹配（在url中string1、string2顺序出现）判断实现起来要比string1 &amp;&amp; string2容易得多</del>，而目前已知的所有非普通关键词都是string1 &amp;&amp; string2形式而不是string1<em>string2形式，是否存在string1</em>string2形式的关键词需要知道更多的URL关键词。</li>
</ul>
<p>判断一个URL是否包含关键词的方法十分明了，选择一个跟本地IP分别在GFW两端的目标IP da，再任意选择一个不等于___的目标端口dp。对(da, dp)单向发送s;a;pa;s。（s = SYN; a = ACK; p = PSH）。为保证GFW按照顺序看到可以将每个包重复发送多遍，两组包间隔一定时间发送。如果触发了type1关键词可以收到GFW的r（RST），触发type2关键词可以收到GFW的sa。无sa或者无r，并不能说明不包含关键词，可能是GFW的相应结点不工作了。这时应该可以对此(da, dp)发送www.youtube.com来尝试触发。触发，说明原本确实没有关键词；否则说明GFW的相应类型的相应结点不工作了。</p>
<p>对关键词进行手工求解未免太过低效，利用GFW的单向报文检测特性，可以用来进行关键词检测的(da, dp)是几乎无穷多而且便于寻找的，让程序自动检测关键词非常可行。</p>
<ul>
<li>情况1、假定只有一个关键词。<ul>
<li>假设str长len，发起len个询问，第i个询问检测str去掉第i个字符形成的字符串。如果有阻断，说明这个字母可以去掉，否则说明这个字母不能去掉。询问完全并行。拿到所有结果之后可以立刻求出关键词。</li>
<li>理想情况下只要1单位时间。</li>
</ul>
</li>
<li>情况2、假定所有关键词都是普通关键词，求出所有最小关键词。<ul>
<li>这种情况下可以进一步假定关键词是互不包含的子串，所以关键词可以定义前后关系。假设str长度为len，发起len个询问，第i个询问去掉前len + 1 - i个字符。求出最大的j使得在去掉前j个字符的情况下仍然有关键词。现在只需要求出从第j+1个字符开始的关键词，发起len - j个询问，第i个询问去掉后len - j + 1 - i个字符。现在求出最大的k使得去掉后k个字符仍然有关键词就完了。最后一个关键词就是str[j + 1..len - k]，共花去2单位时间、询问。接下来处理str[1..len - k - 1] with hint: “开头位置 &lt;= j”，仍然是倒着测，有助于及时break。</li>
<li>理想情况下时间等于关键词数目。</li>
<li>为了减少(da, dp)的报废数目（短时间报废过多会被迫等待继发封锁结束），可以使用“二级索引”的办法：分sqrt(len)块，然后再精确到块内的位置。这样只是时间*2。</li>
</ul>
</li>
<li>情况3、&amp;&amp;型关键词、可能有多个，求出所有关键词。<ul>
<li>即使是求出其中的某一个关键词都是必须串行的，要花len的时间，难以忍受。但是实践中，.google.com &amp;&amp; <strong> 和 search &amp;&amp; </strong> 和 q=<strong> 有可能同时是关键词，而询问作为www.google.com/search?q=</strong>出现。由于此问题可由3-SAT规约到，是NPC问题，认为不可完成，所以从其它方面考虑：</li>
</ul>
<ol>
<li>根据经验假设只会出现2个&amp;&amp;，但实现带任意多&amp;&amp;的关键词的匹配算法上并不困难，GFW应该有相应的计算能力。</li>
<li>令s为{1..len}的一个随机置换，顺次考察s[i]，如果去掉后仍然触发就去掉，不再触发就保留。最后可以得到一个关键词。多路并行应该就可以求出所有关键词了。尽管到达每个关键词的概率不均匀，实践效果应该可以接受。</li>
</ol>
</li>
</ul>
<h4 id="深度检测关键词和其他关键词检测"><a href="#深度检测关键词和其他关键词检测" class="headerlink" title="深度检测关键词和其他关键词检测"></a>深度检测关键词和其他关键词检测</h4><p>GFW对所有通信进行了全文关键词检测，并且可以对gzip、deflate压缩的报文实现实时解压缩判断。进行这种关键词检测，需要事先准备好被测试文本。如果是某网页或者某文件含有深度检测关键词，需要将相应文件下载到本地。与测试URL关键字不同之处就是文件可以非常大。上面的方法几乎行不通。但我们希望先缩小关键词的寻找范围。希望根据GFW的r或者ra包的序列号来定位出现关键词的两个包，这样被检测字符串的长度就被缩小到了不到3000字节，就可以套用上面的方法了。</p>
<p>由于GFW的r和ra的seq是取自本地发出包的ack，只要对每个包按照发送顺序设置ack。</p>
<p>坑了（事实上）。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://Mauerspecht.org/2012/09/24/gfw_http_keywords/" data-id="cj7d1fmsf0000gc0krpl7xklt" class="article-share-link">Share</a><div class="tags"><a href="/tags/HTTP-URL/">HTTP URL</a></div><div class="post-nav"><a href="/2016/03/10/Mauerspecht-in-Wikipedia/" class="pre">Mauerspecht in Wikipedia</a><a href="/2012/05/17/gfw_check/" class="next">GFW 研究与诊断工具</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://Mauerspecht.org"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/长城防火墙/" style="font-size: 15px;">长城防火墙</a> <a href="/tags/mauerspecht/" style="font-size: 15px;">mauerspecht</a> <a href="/tags/一字之差/" style="font-size: 15px;">一字之差</a> <a href="/tags/DNS篡改/" style="font-size: 15px;">DNS篡改</a> <a href="/tags/联合国/" style="font-size: 15px;">联合国</a> <a href="/tags/人权理事会/" style="font-size: 15px;">人权理事会</a> <a href="/tags/中国季刊/" style="font-size: 15px;">中国季刊</a> <a href="/tags/ChinaQuarterly/" style="font-size: 15px;">ChinaQuarterly</a> <a href="/tags/berlin-wall/" style="font-size: 15px;">berlin wall</a> <a href="/tags/GFW/" style="font-size: 15px;">GFW</a> <a href="/tags/俄罗斯/" style="font-size: 15px;">俄罗斯</a> <a href="/tags/土耳其/" style="font-size: 15px;">土耳其</a> <a href="/tags/反华/" style="font-size: 15px;">反华</a> <a href="/tags/Reagan/" style="font-size: 15px;">Reagan</a> <a href="/tags/VPN/" style="font-size: 15px;">VPN</a> <a href="/tags/censorship/" style="font-size: 15px;">censorship</a> <a href="/tags/Apple/" style="font-size: 15px;">Apple</a> <a href="/tags/UML/" style="font-size: 15px;">UML</a> <a href="/tags/graphvia/" style="font-size: 15px;">graphvia</a> <a href="/tags/plant-UML/" style="font-size: 15px;">plant UML</a> <a href="/tags/博讯/" style="font-size: 15px;">博讯</a> <a href="/tags/公开信/" style="font-size: 15px;">公开信</a> <a href="/tags/审查/" style="font-size: 15px;">审查</a> <a href="/tags/United-Nations/" style="font-size: 15px;">United Nations</a> <a href="/tags/Human-Rights-Council/" style="font-size: 15px;">Human Rights Council</a> <a href="/tags/wiki/" style="font-size: 15px;">wiki</a> <a href="/tags/HTTP-URL/" style="font-size: 15px;">HTTP URL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/un-china-blocks-activists-harasses-experts_cn/">联合国：中国阻挠维权人士、骚扰专家</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/un-china-blocks-activists-harasses-experts/">China Blocks Activists, Harasses Experts</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/22/test_dns_pollution/">测量全球的 DNS 纂改</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/22/China_Quarterly_2/">面对学术界反弹 《中国季刊》300篇被删文章恢复发表</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/19/How_does_gfw_work/">中國的網路寒冬：防火長城究竟如何運作？</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/19/China_Quarterly_1/">《中国季刊》:对中国删300多篇文章深表关注</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/13/about-Tex/">about-Tex</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/06/Turkey_media_anti-china_2/">土耳其外长：我国境内不得反华</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/Turkey_media_anti-china/">誓言空洞? 土耳其承诺将在国内媒体中消除反华报道</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/03/apple_remove_vpn/">Apple removes VPN apps in China as Beijing doubles down on censorship</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="https://zh.greatfire.org/" title="Great Fire" target="_blank">Great Fire</a><ul></ul><a href="https://program-think.blogspot.com" title="编程随想" target="_blank">编程随想</a><ul></ul><a href="https://pao-pao.net" title="泡泡" target="_blank">泡泡</a><ul></ul><a href="https://xiaolan.me/" title="Xiaolan's Blog" target="_blank">Xiaolan's Blog</a><ul></ul><a href="http://www.chinagfw.org" title="GFW Blog" target="_blank">GFW Blog</a><ul></ul><a href="https://2xiangzi.blogspot.com/" title="二翔子的博客" target="_blank">二翔子的博客</a><ul></ul><a href="https://gfw.press/" title="GFW.Press" target="_blank">GFW.Press</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Mauerspecht.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>